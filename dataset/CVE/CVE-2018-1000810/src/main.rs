/**
 * CVE-2018-1000810
 * How to reproduce this bug: 
 *     - This bug need to be reproduced in release build.
 *     - cargo run --release
 */

extern crate core;

use core::ptr;
#[no_mangle]
fn repeat() {

	let a = b"0123456789abcdef";
	let n: usize = 1 << 63;


	let mut buf : Vec<u8> = Vec::with_capacity(a.len() * n);
	// let mut buf = Vec::with_capacity(a.len().checked_mul(n).expect("capacity overflow"));

	buf.extend(a);

	{
		let mut m = n >> 1;

		while m > 0 {
			unsafe {
				ptr::copy_nonoverlapping(buf.as_ptr(), (buf.as_mut_ptr() as *mut u8).add(buf.len()), buf.len());

				let buf_len = buf.len();
				buf.set_len(buf_len * 2);
			}

			m >>= 1;
		}
	}

	let rem_len = a.len() * n - buf.len();

	if rem_len > 0 {
		unsafe{
			ptr::copy_nonoverlapping(buf.as_ptr(), (buf.as_mut_ptr() as *mut u8).add(buf.len()), rem_len);

			let buf_cap = buf.capacity();
			buf.set_len(buf_cap);
		}
	}

	println!("{} {}", buf.len(), buf.capacity());
}
fn main() {

	repeat();

}
